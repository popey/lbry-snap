#!/usr/bin/env bash

# On Fedora $SNAP is under /var and there is some magic to map it to /snap.
# We need to handle that case and reset $SNAP
SNAP=$(echo $SNAP | sed -e "s|/var/lib/snapd||g")

if [ "$SNAP_ARCH" == "amd64" ]; then
  ARCH="x86_64-linux-gnu"
elif [ "$SNAP_ARCH" == "armhf" ]; then
  ARCH="arm-linux-gnueabihf"
elif [ "$SNAP_ARCH" == "arm64" ]; then
  ARCH="aarch64-linux-gnu"
else
  ARCH="$SNAP_ARCH-linux-gnu"
fi

export XDG_CACHE_HOME=$SNAP_USER_COMMON/.cache
if [[ -d $SNAP_USER_DATA/.cache && ! -e $XDG_CACHE_HOME ]]; then
  # the .cache directory used to be stored under $SNAP_USER_DATA, migrate it
  mv $SNAP_USER_DATA/.cache $SNAP_USER_COMMON/
fi
mkdir -p $XDG_CACHE_HOME

# Gdk-pixbuf loaders
export GDK_PIXBUF_MODULE_FILE=$XDG_CACHE_HOME/gdk-pixbuf-loaders.cache
export GDK_PIXBUF_MODULEDIR=$SNAP/usr/lib/$ARCH/gdk-pixbuf-2.0/2.10.0/loaders
if [ -f $SNAP/usr/lib/$ARCH/gdk-pixbuf-2.0/gdk-pixbuf-query-loaders ]; then
  $SNAP/usr/lib/$ARCH/gdk-pixbuf-2.0/gdk-pixbuf-query-loaders > $GDK_PIXBUF_MODULE_FILE
fi

# Create $XDG_RUNTIME_DIR if not exists (to be removed when https://pad.lv/1656340 is fixed)
[ -n "$XDG_RUNTIME_DIR" ] && mkdir -p $XDG_RUNTIME_DIR -m 700

# Seed initial config so we don't write blobs to versioned folders
if [ ! -f $SNAP_USER_DATA/.local/share/lbry/lbrynet/daemon_settings.yml ]; then
	echo "Seeding daemon_settings.yml"
	mkdir -p $SNAP_USER_DATA/.local/share/lbry/lbrynet/
	echo "data_dir: $SNAP_USER_COMMON/" > $SNAP_USER_DATA/.local/share/lbry/lbrynet/daemon_settings.yml
	echo "wallet_dir: $SNAP_USER_COMMON/" >> $SNAP_USER_DATA/.local/share/lbry/lbrynet/daemon_settings.yml
fi

# See if the password-manager-service is connected, if not, we need to prompt the user to connect it
if snapctl is-connected password-manager-service; then
  echo "Password manager service is connected"
else
  CONNECTION_TITLE="Unable to use desktop keyring"
  CONNECTION_TEXT="This snap currently requires access to the desktop keyring to store login credentials.\
  \\n\\n\
  Note: the various keyring services do not provide sufficient isolation for snap access to the\\n\
  interface to be auto-connected by default. Not only can the snap see all stored passwords, but\\n \
  all other applications with access to the password services can also see the snapâ€™s passwords.\\n\
  \\n\\n\
  <b>If you wish to connect the interface, in a terminal run the following command:</b>\
  \\n\\n\
  <tt>sudo snap connect lbry:password-manager-service</tt>\\n\
  \\n\\n\
  Then come back here and continue or restart the application completely.\
  If connected, this dialog will no longer appear.\
  \\n\\n\
  Visit the following link for more details:\
  https://forum.snapcraft.io/t/password-manager-service-for-lbry-snap/15644"

  # Display migration alert
  $SNAP/usr/bin/yad \
    --title="${CONNECTION_TITLE}" \
    --text="${CONNECTION_TEXT}" \
    --center \
    --on-top \
    --auto-kill \
    --fixed
fi

exec "$@"
